<div class="w-full flex items-stretch gap-5 flex-wrap lg:flex-nowrap">

    <!-- Left-->
    <div class=" bg-[#1E1E1E] flex-1 min-w-[300px] flex rounded-md">


        <div class="flex flex-col items-start flex-1 self-stretch h-full gap-0">


            <div class="relative w-full aspect-video bg-black rounded-md overflow-hidden shadow-2xl shrink-0 group">


                <video #videoElement autoplay playsinline class="w-full h-full object-cover transform scale-x-[-1]"
                    [muted]="!isPlaying()">
                </video>


                @if (!stream && !errorMessage()) {
                <div class="absolute inset-0 flex items-center justify-center bg-[#1E2024]">
                    <div class="w-8 h-8 rounded-full border-2 border-[#6834FF] border-t-transparent animate-spin">
                    </div>
                </div>
                }


                @if (errorMessage()) {
                <div class="absolute inset-0 flex items-center justify-center bg-[#1E2024] p-4 text-center">
                    <p class="text-red-400 text-sm">{{ errorMessage() }}</p>
                </div>
                }


                @if (stream) {

                @if (testState() === 'completed' && !isPlaying()) {
                <div class="absolute inset-0 flex items-center justify-center z-10">
                    <button (click)="playRecording()"
                        class="transform transition-transform hover:scale-110 focus:outline-none">
                        <img src="/video-play-button.svg" alt="Play" class="w-20 h-20 opacity-90 hover:opacity-100">
                    </button>
                </div>
                }


                <div
                    class="absolute bottom-4 md:bottom-6 left-1/2 -translate-x-1/2 flex items-center gap-3 md:gap-4 z-20">

                    @if (testState() === 'idle') {
                    <button (click)="startRecording()"
                        class="bg-[#F0EBFF] px-6 py-2.5 text-[#6834FF] text-sm rounded-full border-8 border-[rgba(11,19,49,0.6)]">
                        Start Test
                    </button>
                    }
                    @else if (testState() === 'running') {
                    <button (click)="stopRecordingAndCheck()"
                        class="px-6 py-2.5 bg-red-100 text-red-500 text-sm font-semibold rounded-full border-8 border-[rgba(11,19,49,0.6)] flex items-center gap-2">
                        Stop
                        <div class=" border-2 border-red-500 rounded-full w-4 h-4 flex items-center justify-center">
                            <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                        </div>
                    </button>
                    }
                    @else if (testState() === 'completed') {


                    <button (click)="tryAgain()"
                        class="px-6 py-2.5  text-[#6834FF] bg-[#F0EBFF] bg-[] text-sm font-semibold shadow-lg flex items-center gap-2  rounded-full border-8 border-[rgba(11,19,49,0.6)]">
                        Try again
                    </button>
                    }
                </div>
                }
            </div>

            <!-- Settings -->
            <div
                class="flex flex-col gap-2 p-2 sm:p-4 items-start content-start self-stretch flex-wrap rounded-b-md bg-dark-card">

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 w-full">

                    <div class="space-y-1.5">
                        <label class="text-xs text-gray-400 font-medium ml-1">Speakers</label>
                        <div class="relative">
                            <select [ngModel]="selectedSpeaker()" (ngModelChange)="selectedSpeaker.set($event)"
                                class="w-full bg-[#272B30] text-sm text-gray-200 rounded-lg px-4 py-3 border border-white/5 focus:border-[#6834FF] focus:outline-none appearance-none cursor-pointer hover:bg-[#2A2D32] transition-colors">
                                <option *ngFor="let device of audioOutputDevices(); let i = index"
                                    [value]="device.deviceId">
                                    {{ device.label || 'Speaker ' + (i + 1) }}
                                </option>
                                <option *ngIf="audioOutputDevices().length === 0" value="default">Default Speaker
                                </option>
                            </select>
                            <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                        </div>
                    </div>


                    <div class="space-y-1.5">
                        <label class="text-xs text-gray-400 font-medium ml-1">Microphone</label>
                        <div class="relative">
                            <select [ngModel]="selectedMic()" (ngModelChange)="selectedMic.set($event)"
                                class="w-full bg-[#272B30] text-sm text-gray-200 rounded-lg px-4 py-3 border border-white/5 focus:border-[#6834FF] focus:outline-none appearance-none cursor-pointer hover:bg-[#2A2D32] transition-colors">
                                <option *ngFor="let device of audioInputDevices(); let i = index"
                                    [value]="device.deviceId">
                                    {{ device.label || 'Microphone ' + (i + 1) }}
                                </option>
                                <option *ngIf="audioInputDevices().length === 0" value="default">Default Microphone
                                </option>
                            </select>
                            <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                        </div>
                    </div>



                    <div class="space-y-1.5">
                        <label class="text-xs text-gray-400 font-medium ml-1">Camera</label>
                        <div class="relative">
                            <select [ngModel]="selectedCamera()" (ngModelChange)="selectedCamera.set($event)"
                                class="w-full bg-[#272B30] text-sm text-gray-200 rounded-lg px-4 py-3 border border-white/5 focus:border-[#6834FF] focus:outline-none appearance-none cursor-pointer hover:bg-[#2A2D32] transition-colors">
                                <option *ngFor="let device of videoInputDevices(); let i = index"
                                    [value]="device.deviceId">
                                    {{ device.label || 'Camera ' + (i + 1) }}
                                </option>
                                <option *ngIf="videoInputDevices().length === 0" value="default">Default Camera
                                </option>
                            </select>
                            <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                        </div>
                    </div>


                    <div class="space-y-1.5">
                        <label class="text-xs text-gray-400 font-medium ml-1">Enhancements</label>
                        <div class="flex gap-1.5 h-[46px]">
                            <button (click)="blurEnabled.set(!blurEnabled())" [class.bg-[#2A2D32]]="!blurEnabled()"
                                [class.bg-[#3D4045]]="blurEnabled()"
                                class="flex-1 flex items-center justify-center gap-2 px-3 rounded-lg text-sm font-medium transition-all border border-white/5 hover:bg-[#32363C] text-gray-300 h-full">
                                <img src="blur.svg" alt="">
                                Background Blur
                            </button>

                            <button (click)="noiseCancellationEnabled.set(!noiseCancellationEnabled())"
                                [class.bg-[#2A2D32]]="!noiseCancellationEnabled()"
                                [class.bg-[#3D4045]]="noiseCancellationEnabled()"
                                class="flex-1 flex items-center justify-center gap-2 px-3 rounded-lg text-sm font-medium transition-all border border-white/5 hover:bg-[#32363C] text-gray-300 h-full">
                                <img src="noice.svg" alt="">
                                Noise Cancellation
                            </button>
                        </div>
                    </div>



                </div>


                @if(testState() === 'idle') {
                <div class="flex w-full p-2 flex-col items-start gap-2 rounded-md border border-blue-500 bg-white">
                    <div class="flex items-start gap-2 self-stretch">
                        <img src="information-circle.svg" alt="">
                        <p class="flex-1 text-black font-normal text-xs leading-5">Please use the built-in noise
                            cancellation on Mac and iOS devices.</p>
                    </div>
                </div>
                }
            </div>
        </div>

    </div>

    <!-- Right -->
    <div class="flex-1 min-w-[300px] flex bg-[#1E1E1E] rounded-md">

        <div class="flex w-full p-3 flex-col items-start gap-3 rounded-md bg-dark-card h-full justify-between">

            <div class="flex items-center gap-4 self-stretch">
                <h2 class="flex-1 text-white font-semibold text-xl leading-7">Quick check</h2>
            </div>


            <div class="flex flex-col items-start gap-6 flex-1 self-stretch pt-2">

                @if (testState() === 'idle' || testState() === 'running') {

                <div class="flex items-start gap-2 self-stretch">
                    <div class="flex flex-col justify-center items-start flex-1">
                        <p class="self-stretch text-white text-lg leading-7">
                            <span class="font-normal">When you're ready, click Start </span>
                            <span class="font-semibold">Test</span>
                            <span class="font-normal"> and then read the words on screen out loud.</span>
                        </p>
                    </div>
                </div>


                <div class="flex items-start gap-2 self-stretch">
                    <div class="flex flex-col justify-center items-start flex-1">
                        <div class="self-stretch text-white leading-7">
                            <span class="font-normal text-lg">Test words:
                            </span>
                            <span class=" text-lg italic text-gray-300 block">"Hello, I am
                                checking my microphone and camera to
                                make sure everything is working properly before the session begins."</span>
                        </div>
                    </div>
                </div>
                } @else if (testState() === 'analyzing') {

                <div class="flex flex-col gap-6 w-full">

                    <div class="flex gap-4 items-start">
                        <div class="mt-1">
                            @if(cameraStatus() === 'pending' || cameraStatus() === 'checking') {
                            <img src="/refresh-icon.svg" alt="Checking" class="w-5 h-5 animate-spin">
                            } @else if(cameraStatus() === 'success') {
                            <img src="/checkmark-icon.svg" alt="Success" class="w-5 h-5">
                            } @else {
                            <div
                                class="w-5 h-5 rounded-full border-2 border-red-500 flex items-center justify-center text-red-500">
                                <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                                    stroke-width="3">
                                    <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                            </div>
                            }
                        </div>
                        <div>
                            <h3 class="text-white font-medium mb-1">Camera</h3>
                            <p class="text-sm text-gray-400">
                                @if(cameraStatus() === 'checking') { Checking... }
                                @else if(cameraStatus() === 'success') { Camera is working well. }
                                @else if(cameraStatus() === 'failure') { Camera access failed. }
                                @else { Waiting... }
                            </p>
                        </div>
                    </div>


                    <div class="flex gap-4 items-start">
                        <div class="mt-1">
                            @if(micStatus() === 'pending') {
                            <div class="w-5 h-5 rounded-full border-2 border-gray-700"></div>
                            } @else if(micStatus() === 'checking') {
                            <img src="/refresh-icon.svg" alt="Checking" class="w-5 h-5 animate-spin">
                            } @else if(micStatus() === 'success') {
                            <img src="/checkmark-icon.svg" alt="Success" class="w-5 h-5">
                            }
                        </div>
                        <div>
                            <h3 class="text-white font-medium mb-1">Microphone</h3>
                            <p class="text-sm text-gray-400">
                                @if(micStatus() === 'checking') { Checking... }
                                @else if(micStatus() === 'success') { Mic is functioning properly. }
                                @else { Waiting... }
                            </p>
                        </div>
                    </div>


                    <div class="flex gap-4 items-start">
                        <div class="mt-1">
                            @if(networkStatus() === 'pending') {
                            <div class="w-5 h-5 rounded-full border-2 border-gray-700"></div>
                            } @else if(networkStatus() === 'checking') {
                            <img src="/refresh-icon.svg" alt="Checking" class="w-5 h-5 animate-spin">
                            } @else if(networkStatus() === 'success') {
                            <img src="/checkmark-icon.svg" alt="Success" class="w-5 h-5">
                            }
                        </div>
                        <div>
                            <h3 class="text-white font-medium mb-1">Network</h3>
                            <p class="text-sm text-gray-400">
                                @if(networkStatus() === 'checking') { Checking... }
                                @else if(networkStatus() === 'success') { Network connection is stable. }
                                @else { Waiting... }
                            </p>
                        </div>
                    </div>
                </div>
                } @else {

                <div class="flex flex-col gap-6 w-full">


                    <div class="flex gap-4 items-start">
                        <div class="mt-1">
                            @if(cameraStatus() === 'success') {
                            <img src="/camera-check.svg" alt="Success" class="w-5 h-5">
                            } @else {
                            <div
                                class="w-5 h-5 rounded-full border-2 border-red-500 flex items-center justify-center text-red-500">
                                <svg class="w-2.5 h-2.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                                    stroke-width="3">
                                    <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                            </div>
                            }
                        </div>
                        <div>
                            <h3 class="text-white font-medium mb-1">Camera</h3>
                            @if(cameraStatus() === 'success') {
                            <p class="text-sm text-gray-400">Camera is working well. You're clearly visible.</p>
                            } @else {
                            <p class="text-sm text-red-500">Camera access failed.</p>
                            }
                        </div>
                    </div>


                    <div class="flex gap-4 items-start">
                        <div class="mt-1">
                            <img src="/signal-check.svg" alt="Success" class="w-5 h-5">
                        </div>
                        <div>
                            <h3 class="text-white font-medium mb-1">Microphone</h3>
                            <p class="text-sm text-gray-400">Mic is functioning properly. Your voice is clear.</p>
                        </div>
                    </div>


                    <div class="flex gap-4 items-start">
                        <div class="mt-1">
                            <img src="/network-check.svg" alt="Success" class="w-5 h-5">
                        </div>
                        <div>
                            <h3 class="text-white font-medium mb-1">Network</h3>
                            <p class="text-sm text-gray-400">Network quality is good.</p>
                        </div>
                    </div>
                </div>
                }
            </div>


            <div class="flex flex-col gap-4 self-stretch">

                @if(testState() === 'completed') {
                <div class="flex items-center gap-3">
                    <input type="checkbox" id="acknowledge" [checked]="isAcknowledged()"
                        (change)="isAcknowledged.set(!isAcknowledged())"
                        class="w-4 h-4 rounded border-gray-600 bg-[#272B30] text-[#6834FF] focus:ring-[#6834FF]">
                    <label for="acknowledge" class="text-sm text-gray-300 cursor-pointer select-none">
                        I acknowledge that my setup has been tested properly.
                    </label>
                </div>
                }


                <div class="flex flex-col justify-center items-end gap-2.5 self-stretch">
                    <button (click)="joinMeeting()" [disabled]="testState() !== 'completed' || !isAcknowledged()"
                        [class.opacity-40]="testState() !== 'completed' || !isAcknowledged()"
                        [class.cursor-not-allowed]="testState() !== 'completed' || !isAcknowledged()"
                        class="flex h-8 px-4 py-2.5 justify-center items-center gap-1 rounded-md bg-[#F0EBFF] transition-opacity">
                        <span class="text-[#6834FF] font-normal text-xs leading-5">Join</span>
                        <svg class="w-3 h-3" width="12" height="12" viewBox="0 0 12 12" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M3.59998 10.8L7.69287 6.70706C8.0262 6.37372 8.19287 6.20706 8.19287 5.99995C8.19287 5.79284 8.0262 5.62618 7.69287 5.29284L3.59998 1.19995"
                                stroke="#6834FF" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

    </div>
</div>